name: Patch_Kernel_KPM
on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'The ID of the successful build run to release from'
        required: true

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    env:
      # Set the token once for all steps in the job
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Artifacts via GitHub CLI
        run: |
          echo "Downloading artifacts for Run ID ${{ inputs.run_id }}..."
          gh run download ${{ inputs.run_id }} --dir ./downloaded-artifacts --repo ${{ github.repository }}
          pwd
          ls
      - name: Display Downloaded Artifact Structure
        run: ls -R ./downloaded-artifacts
          ls
          pwd

      - name: Apply patch_linux and replace Image
        run: |
          pwd
          cd /downloaded-artifacts/AnyKernel3_CROM_13239__VFS_KPM_LuffyOP⚡/
          pwd
          curl -LO --retry 5 --retry-delay 2 --retry-connrefused https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU_patch/main/kpm/patch_linux
          chmod +x patch_linux
          gzip -d Image.gz
          ./patch_linux
          gzip -c Image > Image.gz
          pwd

      - name: Make AnyKernel3_CROM
        run: |
          pwd
          git clone https://github.com/darklord4567/Anykernel3_AOSP_NORD3.git --depth=1
          echo "Copying Image.gz to Anykernel3_AOSP_NORD3/"
          pwd
          cp Image.gz  $GITHUB_WORKSPACE/Anykernel3_AOSP_NORD3/Image.gz

      - name: Upload AnyKernel3_CROM
        uses: actions/upload-artifact@v4
        with:
          name: KPM_PATCHED_AnyKernel3_CROM_${{ env.KSUVER }}_${{ steps.file_clean.outputs.value }}${{ steps.suffix.outputs.value }}_LuffyOP⚡
          path: ./Anykernel3_AOSP_NORD3/*
